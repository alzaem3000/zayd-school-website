# خطة تثبيت التعديلات وفق منهجية موثوقة

## الهدف
تثبيت المشروع على مسار تطوير يمكن الاعتماد عليه عبر:
1. **وضع محلي للمصادقة (Dev Auth Mode)** لتجاوز الاعتماد على OIDC أثناء الاختبارات المحلية.
2. **اختبار E2E تلقائي** لرحلات المستخدم الأساسية (`Landing` / `Login` / `Home`) داخل CI.
3. **تقليل حجم الحزمة الإنتاجية** لتحسين الأداء عبر `manualChunks` و/أو `dynamic import`.

---

## المنهجية المعتمدة
- **Baseline أولاً**: قياس الوضع الحالي قبل أي تعديل.
- **تعديلات تدريجية صغيرة**: كل محور يُنفذ في فرع/دفعة صغيرة مع تحقق مستقل.
- **بوابة جودة موحدة**: لا دمج بدون نجاح `check + test + build + e2e`.
- **قياس بعدي**: مقارنة الأداء والاعتمادية قبل/بعد.

---

## المرحلة 0: خط الأساس (Baseline)
### الإجراءات
- توثيق نتائج الأوامر الحالية:
  - `npm run check`
  - `npm test`
  - `npm run build`
  - (اختياري) قياس bundle من ناتج `dist/public/assets/*.js`
- حفظ النتائج في تقرير قصير داخل CI artifact.

### معيار النجاح
- توفر قياس واضح للوضع الحالي (نجاح/فشل + زمن + حجم حزمة).

---

## المرحلة 1: إضافة Dev Auth Mode
### الفكرة
عند تفعيل متغير بيئة (مثل `DEV_AUTH_MODE=true`) يتم تجاوز `openid-client discovery` وتفعيل جلسة محلية آمنة للتطوير.

### خطوات التنفيذ
1. إضافة **Feature Flag** في `replitAuth.ts`:
   - إذا `DEV_AUTH_MODE=true`:
     - عدم استدعاء OIDC discovery.
     - تفعيل middleware مصادقة محلية (mock user/session).
2. إضافة endpoint تطويري اختياري:
   - `POST /api/dev-login` (مقيد فقط على `NODE_ENV=development`).
3. حماية الوضع المحلي:
   - تعطيله تلقائيًا إذا `NODE_ENV=production`.
4. تحديث التوثيق:
   - كيفية التشغيل المحلي مع أمثلة `.env`.

### المخاطر والضوابط
- **مخاطرة**: تسرب وضع التطوير للإنتاج.
- **الضبط**: شرط صريح يمنع التفعيل خارج التطوير + اختبار يثبت ذلك.

### معيار النجاح
- `npm run dev` يعمل محليًا دون اتصال OIDC عند تفعيل `DEV_AUTH_MODE=true`.
- مسارات الحماية الأساسية تعمل بمستخدم تجريبي محدد الصلاحيات.

---

## المرحلة 2: إضافة E2E تلقائي داخل CI
### النطاق
رحلات المستخدم الأساسية:
1. فتح `Landing` والتأكد من العناصر المرئية الأساسية.
2. الانتقال إلى `Login` والتأكد من عناصر النموذج.
3. الوصول إلى `Home` (بحسب وضع المصادقة المحلي أو seed session).

### خطوات التنفيذ
1. إعداد Playwright Tests في `tests/e2e`.
2. إعداد تشغيل CI:
   - build للتطبيق.
   - تشغيل server/preview.
   - تنفيذ `npx playwright test`.
3. رفع artifact عند الفشل:
   - screenshots + trace + video.

### معيار النجاح
- نجاح E2E على PRs.
- في حال الفشل: توفر artifacts كافية للتشخيص.

---

## المرحلة 3: تقليل حجم الحزمة الإنتاجية
### منهج التنفيذ
1. **تحليل الحزمة**:
   - استخدام report (مثل rollup visualizer) لتحديد أكبر الوحدات.
2. **تقسيم يدوي (`manualChunks`)**:
   - فصل vendor الثقيلة (`react`, `radix`, `recharts`, …) إلى chunks منطقية.
3. **تحميل كسول (`dynamic import`)**:
   - الصفحات/المكونات الثقيلة (لوحات التحليلات/مودالات كبيرة) عند الطلب.
4. **تحسينات لاحقة**:
   - مراجعة الاستيراد من المكتبات الكبيرة لتجنب إدخال غير مستخدم.

### مؤشرات النجاح (KPIs)
- انخفاض حجم ملف JS الرئيسي (هدف أولي: 20–35%).
- تحسن زمن تحميل الصفحة الأولى (First Load JS / TTI تقريبي).
- اختفاء/انخفاض تحذيرات chunk size في build.

---

## بوابة الجودة النهائية (Definition of Done)
يُعتبر العمل مكتملًا عند تحقق جميع الشروط:
1. `npm run check` ✅
2. `npm test` ✅
3. `npm run build` ✅
4. `npx playwright test` ✅ داخل CI
5. `DEV_AUTH_MODE` يعمل فقط في التطوير ومغلق في الإنتاج ✅
6. تقرير مقارنة حجم الحزمة قبل/بعد متاح ✅

---

## ترتيب التنفيذ المقترح (أسبوعين)
### الأسبوع 1
- اليوم 1-2: Baseline + تصميم Dev Auth Mode.
- اليوم 3-4: تنفيذ Dev Auth + اختبارات وحدة مرتبطة.
- اليوم 5: توثيق ومراجعة أمنية خفيفة.

### الأسبوع 2
- اليوم 1-2: إعداد E2E + دمج CI artifacts.
- اليوم 3-4: تحسين bundle (`manualChunks` + lazy loading).
- اليوم 5: قياس نهائي + تقرير إغلاق.

---

## مخرجات التسليم
- كود Dev Auth Mode + توثيق التشغيل.
- حزمة اختبارات E2E متكاملة في CI.
- تحسينات build performance مع تقرير قياسي قبل/بعد.
